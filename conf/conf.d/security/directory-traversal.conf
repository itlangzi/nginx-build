# 目录穿越穿越防护公共配置
# 适用场景：所有需要防御目录穿越攻击的server块

set $security_log logs/$server_name-security.log;

# 1. 拦截目录穿越特征（包含../、..\及其URL编码）
if ($request_uri ~* "\.\./|..\\|%2e%2e%2f"){
    return 444;
}

# 2. 限制请求路径中的合法字符（仅允许字母、数字、常见符号）
# if ($request_uri ~* "[^a-zA-Z0-9_\-./?&=]") {
#    # 拒绝包含特殊字符的请求（根据业务需求调整允许的字符集）
#    return 403;
# }

# 3. 禁止访问系统敏感目录
location ~* ^/(etc|proc|dev|bin|sbin|usr|lib|lib64|root) {
    return 444;
    access_log $security_log;
    log_not_found on;
}

# 4. 禁止访问隐藏文件（.git、.htaccess、.htpasswd等文件）
location ~ /\. {
    return 444;
    access_log $security_log;
    log_not_found on;
}

# 5. 禁止访问敏感文件类型（日志、备份、配置文件等）
location ~* (\.log|\_sql|\_bak|.git|.svn|.ini|.conf|.db)$ {
    return 444;
    access_log $security_log;
    log_not_found on;
}

# 6. 路径规范化与范围校验（需在具体location中配合使用）
# 使用示例：
# location /files/ {
#     alias /var/www/example.com/files/;
#     include /etc/nginx/conf.d/security/path-validation.conf;
# }